# Style-Deploy-UI-FINAL.ps1
# PowerShell 5.1 ready. Run from Windows PowerShell ISE or powershell.exe -STA -File "Style-Deploy-UI-FINAL.ps1"

# --- STA auto-restart shim ---
try { $apartment = [System.Threading.Thread]::CurrentThread.GetApartmentState().ToString() } catch { $apartment = "Unknown" }
if ($apartment -ne "STA") {
    $scriptPath = $PSCommandPath
    if (-not $scriptPath) { $scriptPath = $MyInvocation.MyCommand.Definition }
    $args = @("-STA","-NoProfile","-ExecutionPolicy","Bypass","-File", "`"$scriptPath`"")
    Start-Process -FilePath (Join-Path $env:SystemRoot "System32\WindowsPowerShell\v1.0\powershell.exe") -ArgumentList $args -WindowStyle Normal
    return
}

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# ---------- Config ----------
$baseSnapshotUrl = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-snapshots-local/com/natwest/style"
$baseReleaseUrl  = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-releases-local/com/natwest/style"
$defaultLocalPath = "D:\Style"
$defaultLocalPathApp = "D:\app\style"
$logRoot = "D:\Temp\deployments"

# ---------- Fatal logger ----------
function Write-Fatal { param([string]$msg)
    try {
        $dateFolder = (Get-Date).ToString("yyyy-MM-dd")
        $dir = Join-Path $logRoot "logs\$dateFolder"
        New-Item -ItemType Directory -Force -Path $dir | Out-Null
        $f = Join-Path $dir "fatal-exception.log"
        $entry = "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $msg"
        Add-Content -Path $f -Value $entry -ErrorAction SilentlyContinue
    } catch {}
}

# ---------- Safe UI invoke ----------
function Safe-UIInvoke { param([ScriptBlock]$sb)
    try {
        if ($form -and $form.InvokeRequired) { return $form.Invoke($sb) } else { return & $sb }
    } catch {
        Write-Fatal "Safe-UIInvoke exception: $($_.Exception.Message)"
        throw
    }
}

# ---------- Robust Write-Log (always writes to a file - fallback) ----------
function Write-Log {
    param([string]$message, [string]$logFilePath)

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $entry = "[$timestamp] $message"

    # UI append if available
    if ($global:uiLogBox -ne $null) {
        try {
            Safe-UIInvoke {
                $global:uiLogBox.AppendText("$entry`r`n")
                $global:uiLogBox.SelectionStart = $global:uiLogBox.Text.Length
                $global:uiLogBox.ScrollToCaret()
            }
        } catch { }
    }

    # final log path (use provided or fallback startup.log)
    if ($logFilePath -and $logFilePath.Trim().Length -gt 0) {
        $finalLog = $logFilePath
    } else {
        $dateFolder = (Get-Date).ToString("yyyy-MM-dd")
        $fallbackDir = Join-Path $logRoot "logs\$dateFolder"
        try { New-Item -ItemType Directory -Force -Path $fallbackDir | Out-Null } catch {}
        $finalLog = Join-Path $fallbackDir "startup.log"
    }

    try {
        $parent = Split-Path $finalLog -Parent
        if ($parent) { New-Item -ItemType Directory -Force -Path $parent | Out-Null }
        Add-Content -Path $finalLog -Value $entry -ErrorAction Stop
        return $finalLog
    } catch {
        try {
            $tmp = Join-Path $env:TEMP "style-deploy-fallback.log"
            Add-Content -Path $tmp -Value $entry -ErrorAction SilentlyContinue
            return $tmp
        } catch { return $null }
    }
}

# ---------- Helpers ----------
function Ensure-Dirs { param($targetDir, $logFilePath)
    try {
        if ($targetDir) { New-Item -ItemType Directory -Force -Path $targetDir | Out-Null }
        if ($logFilePath) { New-Item -ItemType Directory -Force -Path (Split-Path $logFilePath -Parent) | Out-Null }
    } catch { Write-Log "Ensure-Dirs error: $($_.Exception.Message)" $logFilePath }
}

function Build-ArtifactUrl { param($artifactName, $artifactVersion)
    $isSnapshot = $artifactVersion -like "*SNAPSHOT*"
    if ($isSnapshot) { return "$baseSnapshotUrl/$artifactName/$artifactVersion/$artifactName-$artifactVersion.jar" }
    else { return "$baseReleaseUrl/$artifactName/$artifactVersion/$artifactName-$artifactVersion.jar" }
}

function Download-Artifact { param($url, $outPath, $logFile)
    try {
        Invoke-WebRequest -Uri $url -OutFile $outPath -UseBasicParsing -ErrorAction Stop
        Write-Log "Download successful to $outPath." $logFile
        return $true
    } catch {
        Write-Log "Download failed: $($_.Exception.Message)" $logFile
        return $false
    }
}

# ---------- UI layout ----------
$form = New-Object System.Windows.Forms.Form
$form.Text = "Style Artifact Deployment Tool (PS 5.1)"
$form.StartPosition = "CenterScreen"
$form.Size = New-Object System.Drawing.Size(760,560)
$font = New-Object System.Drawing.Font("Segoe UI",10)
$form.Font = $font
$form.BackColor = [System.Drawing.Color]::WhiteSmoke

$table = New-Object System.Windows.Forms.TableLayoutPanel
$table.Dock = "Fill"
$table.ColumnCount = 3
$table.RowCount = 8
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,180)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,120)))
for ($i=0; $i -lt $table.RowCount; $i++) { $table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,40))) }
$table.Padding = New-Object System.Windows.Forms.Padding(10)
$form.Controls.Add($table)

# Row 0
$lblComponent = New-Object System.Windows.Forms.Label; $lblComponent.Text = "Deployment Component"; $lblComponent.TextAlign = "MiddleLeft"; $lblComponent.Dock = "Fill"
$componentBox = New-Object System.Windows.Forms.ComboBox; $componentBox.Dock = "Fill"; $componentBox.DropDownStyle = "DropDownList"; $componentBox.Items.AddRange(@("style","style-ms")); $componentBox.SelectedIndex = 0
$btnOpenFolder = New-Object System.Windows.Forms.Button; $btnOpenFolder.Text = "Open Folder"; $btnOpenFolder.Dock = "Fill"
$table.Controls.Add($lblComponent,0,0); $table.Controls.Add($componentBox,1,0); $table.Controls.Add($btnOpenFolder,2,0)

# Row 1
$lblService = New-Object System.Windows.Forms.Label; $lblService.Text = "Service Name"; $lblService.TextAlign = "MiddleLeft"; $lblService.Dock = "Fill"
$serviceBox = New-Object System.Windows.Forms.ComboBox; $serviceBox.Dock = "Fill"; $serviceBox.DropDownStyle = "DropDownList"
$btnRefresh = New-Object System.Windows.Forms.Button; $btnRefresh.Text = "Refresh"; $btnRefresh.Dock = "Fill"
$table.Controls.Add($lblService,0,1); $table.Controls.Add($serviceBox,1,1); $table.Controls.Add($btnRefresh,2,1)

# Row 2
$lblVersion = New-Object System.Windows.Forms.Label; $lblVersion.Text = "Artifact Version"; $lblVersion.TextAlign = "MiddleLeft"; $lblVersion.Dock = "Fill"
$versionBox = New-Object System.Windows.Forms.TextBox; $versionBox.Dock = "Fill"; $versionBox.Text = ""
$btnExamples = New-Object System.Windows.Forms.Button; $btnExamples.Text = "Examples"; $btnExamples.Dock = "Fill"
$table.Controls.Add($lblVersion,0,2); $table.Controls.Add($versionBox,1,2); $table.Controls.Add($btnExamples,2,2)

# Row 3
$lblTarget = New-Object System.Windows.Forms.Label; $lblTarget.Text = "Target Folder"; $lblTarget.TextAlign = "MiddleLeft"; $lblTarget.Dock = "Fill"
$targetBox = New-Object System.Windows.Forms.ComboBox; $targetBox.Dock = "Fill"; $targetBox.DropDownStyle = "DropDownList"; $targetBox.Items.AddRange(@($defaultLocalPath, $defaultLocalPathApp)); $targetBox.SelectedIndex = 0
$btnBrowseTarget = New-Object System.Windows.Forms.Button; $btnBrowseTarget.Text = "Browse"; $btnBrowseTarget.Dock = "Fill"
$table.Controls.Add($lblTarget,0,3); $table.Controls.Add($targetBox,1,3); $table.Controls.Add($btnBrowseTarget,2,3)

# Row 4
$lblProgress = New-Object System.Windows.Forms.Label; $lblProgress.Text = "Progress"; $lblProgress.TextAlign = "MiddleLeft"; $lblProgress.Dock = "Fill"
$progressBar = New-Object System.Windows.Forms.ProgressBar; $progressBar.Dock = "Fill"; $progressBar.Style = "Continuous"; $progressBar.Value = 0
$lblStatus = New-Object System.Windows.Forms.Label; $lblStatus.Text = "Ready"; $lblStatus.TextAlign = "MiddleLeft"; $lblStatus.Dock = "Fill"
$table.Controls.Add($lblProgress,0,4); $table.Controls.Add($progressBar,1,4); $table.Controls.Add($lblStatus,2,4)

# Row 5: log area (span)
$logBox = New-Object System.Windows.Forms.TextBox; $logBox.Multiline = $true; $logBox.ScrollBars = "Vertical"; $logBox.ReadOnly = $true; $logBox.Dock = "Fill"; $logBox.Font = $font
$table.RowStyles[5] = New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent,100)
$table.Controls.Add($logBox,0,5); $table.SetColumnSpan($logBox,3)

# Row 6: actions
$btnPanel = New-Object System.Windows.Forms.FlowLayoutPanel; $btnPanel.FlowDirection = "RightToLeft"; $btnPanel.Dock = "Fill"
$deployButton = New-Object System.Windows.Forms.Button; $deployButton.Text = "Deploy"; $deployButton.Width = 120; $deployButton.Height = 36
$stopButton   = New-Object System.Windows.Forms.Button; $stopButton.Text = "Stop"; $stopButton.Width = 120; $stopButton.Height = 36; $stopButton.Enabled = $false
$closeButton  = New-Object System.Windows.Forms.Button; $closeButton.Text = "Close"; $closeButton.Width = 100; $closeButton.Height = 36
$btnPanel.Controls.Add($closeButton); $btnPanel.Controls.Add($stopButton); $btnPanel.Controls.Add($deployButton)
$table.Controls.Add($btnPanel,0,6); $table.SetColumnSpan($btnPanel,3)

# statusstrip
$status = New-Object System.Windows.Forms.StatusStrip
$stLabel = New-Object System.Windows.Forms.ToolStripStatusLabel; $stLabel.Text = "Ready"; $status.Items.Add($stLabel); $status.Dock = "Bottom"; $form.Controls.Add($status)

# global refs
$global:uiLogBox = $logBox
$global:componentBox = $componentBox
$global:serviceBox = $serviceBox
$global:versionBox = $versionBox
$global:targetBox = $targetBox
$global:currentLogFile = $null

# tooltips & dialogs
$tt = New-Object System.Windows.Forms.ToolTip
$tt.SetToolTip($componentBox,"Which component folder to deploy (affects service listing)")
$tt.SetToolTip($versionBox,"Artifact version (eg. 1.2.3 or 1.2.3-SNAPSHOT)")
$tt.SetToolTip($targetBox,"Target folder for this component on this server")
$folderBrowser = New-Object System.Windows.Forms.FolderBrowserDialog

$btnBrowseTarget.Add_Click({
    if ($folderBrowser.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        if (-not $targetBox.Items.Contains($folderBrowser.SelectedPath)) { $targetBox.Items.Add($folderBrowser.SelectedPath) | Out-Null }
        $targetBox.SelectedItem = $folderBrowser.SelectedPath
    }
})
$btnOpenFolder.Add_Click({
    if ($folderBrowser.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        $componentBox.Text = Split-Path $folderBrowser.SelectedPath -Leaf
    }
})
$btnExamples.Add_Click({
    [System.Windows.Forms.MessageBox]::Show("Examples:`r`n1.0.0`r`n1.0.0-SNAPSHOT`r`n2.5.1","Version examples",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Information)
})

# populate service list
function Populate-ServiceList {
    $serviceBox.Items.Clear()
    $component = $componentBox.Text
    $path = if ($component -eq "style") { $defaultLocalPath } else { $defaultLocalPathApp }
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | ForEach-Object { [void]$serviceBox.Items.Add($_.Name) }
    }
    if ($serviceBox.Items.Count -eq 0) {
        Get-Service | Where-Object { $_.Name -like "*$component*" -or $_.DisplayName -like "*$component*" } | ForEach-Object { [void]$serviceBox.Items.Add($_.Name) }
    }
    if ($serviceBox.Items.Count -gt 0) { $serviceBox.SelectedIndex = 0 }
}
$btnRefresh.Add_Click({ Populate-ServiceList })
$componentBox.Add_SelectedIndexChanged({ Populate-ServiceList })
Populate-ServiceList

# ---------------- BackgroundWorker wiring (PS 5.1) ----------------
$stopRequested = $false
$stopButton.Add_Click({ $stopRequested = $true; Write-Log "Stop requested by user." $global:currentLogFile })

function Disable-Controls($disabled) {
    $deployButton.Enabled = -not $disabled
    $stopButton.Enabled   = -not $disabled
    $componentBox.Enabled = -not $disabled
    $serviceBox.Enabled   = -not $disabled
    $versionBox.Enabled   = -not $disabled
    $targetBox.Enabled    = -not $disabled
}

if ($bw -eq $null -or -not ($bw -is [System.ComponentModel.BackgroundWorker])) { $bw = New-Object System.ComponentModel.BackgroundWorker }
$bw.WorkerReportsProgress = $true
$bw.WorkerSupportsCancellation = $true

# DoWork handler (delegate casting - PS 5.1 friendly)
$doWorkHandler = [System.ComponentModel.DoWorkEventHandler] {
    param($sender,$e)
    try {
        Write-Log "DoWork starting" $global:currentLogFile
        try { $sender.ReportProgress(1) } catch { Write-Log "ReportProgress early failed: $($_.Exception.Message)" $global:currentLogFile }

        # read UI values safely
        $component = Safe-UIInvoke { $componentBox.Text.Trim() }
        $artifact_name = Safe-UIInvoke { $serviceBox.Text.Trim() }
        $artifact_version = Safe-UIInvoke { $versionBox.Text.Trim() }
        $targetDirSelected = Safe-UIInvoke { $targetBox.Text.Trim() }

        if (-not ($component -and $artifact_name -and $artifact_version)) {
            Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show("Please fill all fields.","Missing data",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Warning) }
            $e.Result = @{ Success = $false; Reason = "Missing fields" }
            return
        }

        # Log file setup
        $dateFolderName = (Get-Date).ToString("yyyy-MM-dd")
        $logDir = Join-Path $logRoot "logs"
        $logDir = Join-Path $logDir $dateFolderName
        $logFileName = "$artifact_name-$artifact_version.log"
        $currentLog = Join-Path $logDir $logFileName
        $global:currentLogFile = $currentLog
        Ensure-Dirs -targetDir $targetDirSelected -logFilePath $currentLog

        Write-Log "Starting deployment..." $currentLog
        $sender.ReportProgress(10)

        # Check service status
        $serviceStatus = Get-Service -Name $artifact_name -ErrorAction SilentlyContinue
        if ($serviceStatus -and $serviceStatus.Status -eq 'Running') {
            Write-Log "Service '$artifact_name' is running. Please stop it before deployment." $currentLog
        } else {
            Write-Log "Service '$artifact_name' is not running. Proceeding with deployment." $currentLog
        }
        $sender.ReportProgress(20)

        # Build URL
        $artifactFile = "$artifact_name-$artifact_version.jar"
        $artifactUrl = Build-ArtifactUrl -artifactName $artifact_name -artifactVersion $artifact_version
        Write-Log "Constructed URL: $artifactUrl" $currentLog
        $sender.ReportProgress(30)

        # Download to temp
        $tempFolder = Join-Path $env:TEMP "artifact-deploy"
        New-Item -ItemType Directory -Force -Path $tempFolder | Out-Null
        $downloadPath = Join-Path $tempFolder $artifactFile

        if (-not (Download-Artifact -url $artifactUrl -outPath $downloadPath -logFile $currentLog)) {
            Write-Log "Download failed. Aborting." $currentLog
            $e.Result = @{ Success = $false; Reason = "Download failed" }
            return
        }
        $sender.ReportProgress(50)

        # Determine deploy path
        $deployPath = if ($component -eq "style") { Join-Path $defaultLocalPath $artifact_name } else { Join-Path $defaultLocalPathApp $artifact_name }
        if (-not (Test-Path $deployPath)) {
            Write-Log "Deployment folder '$deployPath' does not exist." $currentLog
            $e.Result = @{ Success = $false; Reason = "Target folder missing"; DeployPath = $deployPath }
            return
        }
        Write-Log "Navigated to deployment folder: $deployPath" $currentLog
        $sender.ReportProgress(60)

        # Remove existing jar
        $existingJar = Join-Path $deployPath "$artifact_name.jar"
        if (Test-Path $existingJar) {
            try { Remove-Item $existingJar -Force -ErrorAction Stop; Write-Log "Removed existing jar: $existingJar" $currentLog } catch { Write-Log "Failed removing existing jar: $($_.Exception.Message)" $currentLog }
        } else { Write-Log "No existing jar found to remove." $currentLog }
        $sender.ReportProgress(80)

        # Copy new artifact
        $newJarPath = Join-Path $deployPath "$artifact_name.jar"
        try {
            Copy-Item -Path $downloadPath -Destination $newJarPath -Force -ErrorAction Stop
            Write-Log "Copied new artifact to: $newJarPath" $currentLog
        } catch {
            Write-Log "Failed to copy artifact: $($_.Exception.Message)" $currentLog
            $e.Result = @{ Success = $false; Reason = "Copy failed"; Error = $_.Exception.Message }
            return
        }

        $sender.ReportProgress(100)
        Write-Log "Deployment completed successfully." $currentLog
        $e.Result = @{ Success = $true }

    } catch {
        Write-Log "Unexpected worker error: $($_.Exception.Message)" $global:currentLogFile
        $e.Result = @{ Success = $false; Reason = "Exception"; Error = $_.Exception.Message }
    }
}

# Progress handler (delegate casting)
$progressHandler = [System.ComponentModel.ProgressChangedEventHandler] {
    param($s,$args)
    Safe-UIInvoke {
        if ($args.ProgressPercentage -ge 0 -and $args.ProgressPercentage -le 100) { $progressBar.Value = $args.ProgressPercentage }
        $stLabel.Text = "In progress: $($args.ProgressPercentage)%"
    }
}

# Diagnostic RunWorkerCompleted handler (logs args.Error and args.Result)
$completedHandler = [System.ComponentModel.RunWorkerCompletedEventHandler] {
    param($s,$args)
    Safe-UIInvoke {
        Disable-Controls $false
        try {
            $errorText = if ($args.Error) { $args.Error.ToString() } else { "<no args.Error>" }
            $resultText = if ($args.Result) { $args.Result | Out-String } else { "<no args.Result>" }
            $diag = "RunWorkerCompleted diagnostics:`r`n--- args.Error ---`r`n$errorText`r`n--- args.Result ---`r`n$resultText"
            Write-Log $diag $global:currentLogFile
            Write-Fatal $diag

            if ($args.Error) {
                $msg = "Deployment failed with exception:`r`n$($args.Error.Message)`r`n(Check logs for details)"
                [System.Windows.Forms.MessageBox]::Show($msg,"Deployment error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error)
                $stLabel.Text = "Error"
            } elseif ($args.Result -and $args.Result.Success -eq $true) {
                $stLabel.Text = "Completed"
                $progressBar.Value = 0
                [System.Windows.Forms.MessageBox]::Show("Deployment completed successfully.","Success",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Information)
            } else {
                $reason = if ($args.Result) { $args.Result.Reason } else { "<no reason provided>" }
                $err = if ($args.Result) { $args.Result.Error } else { "<no error provided>" }
                $msg = "Deployment failed.`r`nReason: $reason`r`nError: $err`r`n(Check logs for diagnostic details.)"
                [System.Windows.Forms.MessageBox]::Show($msg,"Deployment failed",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Warning)
                $stLabel.Text = "Failed"
            }
        } catch {
            Write-Fatal "RunWorkerCompleted diagnostic handler exception: $($_.Exception.Message)"
            [System.Windows.Forms.MessageBox]::Show("Diagnostic handler failed: $($_.Exception.Message)","Diagnostic error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error)
        }
    }
}

# detach previous handlers (safe for re-run in ISE)
try { $bw.remove_DoWork($null) } catch {}
try { $bw.remove_ProgressChanged($null) } catch {}
try { $bw.remove_RunWorkerCompleted($null) } catch {}

# attach the handlers
$bw.add_DoWork($doWorkHandler)
$bw.add_ProgressChanged($progressHandler)
$bw.add_RunWorkerCompleted($completedHandler)

# Deploy button wiring (instrumented start)
$deployButton.Add_Click({
    if ($bw.IsBusy) { Write-Log "Deploy clicked but worker already busy." $global:currentLogFile; return }
    $stopRequested = $false
    Safe-UIInvoke { Disable-Controls $true; $stLabel.Text = "Queued..."; $progressBar.Value = 0 }
    Write-Log "Deploy requested - starting BackgroundWorker." $null
    try {
        Write-Log "Before RunWorkerAsync()" $null
        $bw.RunWorkerAsync()
        Write-Log "After RunWorkerAsync()" $null
    } catch {
        Write-Fatal "RunWorkerAsync threw: $($_.Exception.Message)"
        Write-Log "RunWorkerAsync threw: $($_.Exception.Message)" $null
        Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show("Failed to start worker: $($_.Exception.Message)","Start error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
        Disable-Controls $false
    }
})

$stopButton.Add_Click({
    if ($bw.IsBusy -and $bw.WorkerSupportsCancellation) {
        $stopRequested = $true
        $bw.CancelAsync()
        Write-Log "Stop requested (BackgroundWorker)." $global:currentLogFile
    }
})

$closeButton.Add_Click({ $form.Close() })

# top-level unhandled exception handler
[AppDomain]::CurrentDomain.add_UnhandledException({
    param($sender,$ea)
    try {
        $ex = $ea.ExceptionObject
        $msg = if ($ex -is [System.Exception]) { $ex.Message } else { $ex.ToString() }
        Write-Fatal "Unhandled exception: $msg"
        Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show("Fatal error: $msg","Fatal",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
    } catch {}
})

# show UI
$form.Add_Shown({ $form.Activate() })
$form.Topmost = $true

try { [void]$form.ShowDialog() } catch { Write-Fatal "ShowDialog threw: $($_.Exception.Message)"; [System.Windows.Forms.MessageBox]::Show("UI failed: $($_.Exception.Message) - see $logRoot\logs for details","UI Error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
