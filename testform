# Style-Deploy-UI-Threaded-FIXED.ps1
# Thread-based runner — PowerShell 5.1 friendly. Run from Windows PowerShell ISE or powershell.exe -STA -File "Style-Deploy-UI-Threaded-FIXED.ps1"

# --- STA auto-restart shim ---
try { $apartment = [System.Threading.Thread]::CurrentThread.GetApartmentState().ToString() } catch { $apartment = "Unknown" }
if ($apartment -ne "STA") {
    $scriptPath = $PSCommandPath
    if (-not $scriptPath) { $scriptPath = $MyInvocation.MyCommand.Definition }
    $args = @("-STA","-NoProfile","-ExecutionPolicy","Bypass","-File", "`"$scriptPath`"")
    Start-Process -FilePath (Join-Path $env:SystemRoot "System32\WindowsPowerShell\v1.0\powershell.exe") -ArgumentList $args -WindowStyle Normal
    return
}

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# ---------- Config ----------
$baseSnapshotUrl = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-snapshots-local/com/natwest/style"
$baseReleaseUrl  = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-releases-local/com/natwest/style"
$defaultLocalPath = "D:\Style"
$defaultLocalPathApp = "D:\app\style"
$logRoot = "D:\Temp\deployments"

# ---------- Fatal logger ----------
function Write-Fatal { param([string]$msg)
    try {
        $dateFolder = (Get-Date).ToString("yyyy-MM-dd")
        $dir = Join-Path $logRoot "logs\$dateFolder"
        New-Item -ItemType Directory -Force -Path $dir | Out-Null
        $f = Join-Path $dir "fatal-exception.log"
        $entry = "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] $msg"
        Add-Content -Path $f -Value $entry -ErrorAction SilentlyContinue
    } catch {}
}

# ---------- Safe UI invoke ----------
function Safe-UIInvoke { param([ScriptBlock]$sb)
    try {
        if ($form -and $form.InvokeRequired) { return $form.Invoke($sb) } else { return & $sb }
    } catch {
        Write-Fatal "Safe-UIInvoke exception: $($_.Exception.Message)"
        throw
    }
}

# ---------- Robust Write-Log (always writes to a file - fallback) ----------
function Write-Log {
    param([string]$message, [string]$logFilePath)

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $entry = "[$timestamp] $message"

    # UI append if available
    if ($global:uiLogBox -ne $null) {
        try {
            Safe-UIInvoke {
                $global:uiLogBox.AppendText("$entry`r`n")
                $global:uiLogBox.SelectionStart = $global:uiLogBox.Text.Length
                $global:uiLogBox.ScrollToCaret()
            }
        } catch { }
    }

    # final log path (use provided or fallback startup.log)
    if ($logFilePath -and $logFilePath.Trim().Length -gt 0) {
        $finalLog = $logFilePath
    } else {
        $dateFolder = (Get-Date).ToString("yyyy-MM-dd")
        $fallbackDir = Join-Path $logRoot "logs\$dateFolder"
        try { New-Item -ItemType Directory -Force -Path $fallbackDir | Out-Null } catch {}
        $finalLog = Join-Path $fallbackDir "startup.log"
    }

    try {
        $parent = Split-Path $finalLog -Parent
        if ($parent) { New-Item -ItemType Directory -Force -Path $parent | Out-Null }
        Add-Content -Path $finalLog -Value $entry -ErrorAction Stop
        return $finalLog
    } catch {
        try {
            $tmp = Join-Path $env:TEMP "style-deploy-fallback.log"
            Add-Content -Path $tmp -Value $entry -ErrorAction SilentlyContinue
            return $tmp
        } catch { return $null }
    }
}

# ---------- Helpers ----------
function Ensure-Dirs { param($targetDir, $logFilePath)
    try {
        if ($targetDir) { New-Item -ItemType Directory -Force -Path $targetDir | Out-Null }
        if ($logFilePath) { New-Item -ItemType Directory -Force -Path (Split-Path $logFilePath -Parent) | Out-Null }
    } catch { Write-Log "Ensure-Dirs error: $($_.Exception.Message)" $logFilePath }
}

function Build-ArtifactUrl { param($artifactName, $artifactVersion)
    $isSnapshot = $artifactVersion -like "*SNAPSHOT*"
    if ($isSnapshot) { return "$baseSnapshotUrl/$artifactName/$artifactVersion/$artifactName-$artifactVersion.jar" }
    else { return "$baseReleaseUrl/$artifactName/$artifactVersion/$artifactName-$artifactVersion.jar" }
}

function Download-Artifact { param($url, $outPath, $logFile)
    try {
        Invoke-WebRequest -Uri $url -OutFile $outPath -UseBasicParsing -ErrorAction Stop
        Write-Log "Download successful to $outPath." $logFile
        return $true
    } catch {
        Write-Log "Download failed: $($_.Exception.Message)" $logFile
        return $false
    }
}

# ---------- UI layout (same as previous) ----------
$form = New-Object System.Windows.Forms.Form
$form.Text = "Style Artifact Deployment Tool (Threaded FIXED)"
$form.StartPosition = "CenterScreen"
$form.Size = New-Object System.Drawing.Size(760,560)
$font = New-Object System.Drawing.Font("Segoe UI",10)
$form.Font = $font
$form.BackColor = [System.Drawing.Color]::WhiteSmoke

$table = New-Object System.Windows.Forms.TableLayoutPanel
$table.Dock = "Fill"; $table.ColumnCount = 3; $table.RowCount = 8
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,180)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent,100)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute,120)))
for ($i=0; $i -lt $table.RowCount; $i++) { $table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Absolute,40))) }
$table.Padding = New-Object System.Windows.Forms.Padding(10)
$form.Controls.Add($table)

# Row controls (abbreviated; same as before)
$lblComponent = New-Object System.Windows.Forms.Label; $lblComponent.Text = "Deployment Component"; $lblComponent.TextAlign = "MiddleLeft"; $lblComponent.Dock = "Fill"
$componentBox = New-Object System.Windows.Forms.ComboBox; $componentBox.Dock = "Fill"; $componentBox.DropDownStyle = "DropDownList"; $componentBox.Items.AddRange(@("style","style-ms")); $componentBox.SelectedIndex = 0
$btnOpenFolder = New-Object System.Windows.Forms.Button; $btnOpenFolder.Text = "Open Folder"; $btnOpenFolder.Dock = "Fill"
$table.Controls.Add($lblComponent,0,0); $table.Controls.Add($componentBox,1,0); $table.Controls.Add($btnOpenFolder,2,0)

$lblService = New-Object System.Windows.Forms.Label; $lblService.Text = "Service Name"; $lblService.TextAlign = "MiddleLeft"; $lblService.Dock = "Fill"
$serviceBox = New-Object System.Windows.Forms.ComboBox; $serviceBox.Dock = "Fill"; $serviceBox.DropDownStyle = "DropDownList"
$btnRefresh = New-Object System.Windows.Forms.Button; $btnRefresh.Text = "Refresh"; $btnRefresh.Dock = "Fill"
$table.Controls.Add($lblService,0,1); $table.Controls.Add($serviceBox,1,1); $table.Controls.Add($btnRefresh,2,1)

$lblVersion = New-Object System.Windows.Forms.Label; $lblVersion.Text = "Artifact Version"; $lblVersion.TextAlign = "MiddleLeft"; $lblVersion.Dock = "Fill"
$versionBox = New-Object System.Windows.Forms.TextBox; $versionBox.Dock = "Fill"; $versionBox.Text = ""
$btnExamples = New-Object System.Windows.Forms.Button; $btnExamples.Text = "Examples"; $btnExamples.Dock = "Fill"
$table.Controls.Add($lblVersion,0,2); $table.Controls.Add($versionBox,1,2); $table.Controls.Add($btnExamples,2,2)

$lblTarget = New-Object System.Windows.Forms.Label; $lblTarget.Text = "Target Folder"; $lblTarget.TextAlign = "MiddleLeft"; $lblTarget.Dock = "Fill"
$targetBox = New-Object System.Windows.Forms.ComboBox; $targetBox.Dock = "Fill"; $targetBox.DropDownStyle = "DropDownList"; $targetBox.Items.AddRange(@($defaultLocalPath, $defaultLocalPathApp)); $targetBox.SelectedIndex = 0
$btnBrowseTarget = New-Object System.Windows.Forms.Button; $btnBrowseTarget.Text = "Browse"; $btnBrowseTarget.Dock = "Fill"
$table.Controls.Add($lblTarget,0,3); $table.Controls.Add($targetBox,1,3); $table.Controls.Add($btnBrowseTarget,2,3)

$lblProgress = New-Object System.Windows.Forms.Label; $lblProgress.Text = "Progress"; $lblProgress.TextAlign = "MiddleLeft"; $lblProgress.Dock = "Fill"
$progressBar = New-Object System.Windows.Forms.ProgressBar; $progressBar.Dock = "Fill"; $progressBar.Style = "Continuous"; $progressBar.Value = 0
$lblStatus = New-Object System.Windows.Forms.Label; $lblStatus.Text = "Ready"; $lblStatus.TextAlign = "MiddleLeft"; $lblStatus.Dock = "Fill"
$table.Controls.Add($lblProgress,0,4); $table.Controls.Add($progressBar,1,4); $table.Controls.Add($lblStatus,2,4)

$logBox = New-Object System.Windows.Forms.TextBox; $logBox.Multiline = $true; $logBox.ScrollBars = "Vertical"; $logBox.ReadOnly = $true; $logBox.Dock = "Fill"; $logBox.Font = $font
$table.RowStyles[5] = New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::Percent,100)
$table.Controls.Add($logBox,0,5); $table.SetColumnSpan($logBox,3)

$btnPanel = New-Object System.Windows.Forms.FlowLayoutPanel; $btnPanel.FlowDirection = "RightToLeft"; $btnPanel.Dock = "Fill"
$deployButton = New-Object System.Windows.Forms.Button; $deployButton.Text = "Deploy"; $deployButton.Width = 120; $deployButton.Height = 36
$stopButton   = New-Object System.Windows.Forms.Button; $stopButton.Text = "Stop"; $stopButton.Width = 120; $stopButton.Height = 36; $stopButton.Enabled = $false
$closeButton  = New-Object System.Windows.Forms.Button; $closeButton.Text = "Close"; $closeButton.Width = 100; $closeButton.Height = 36
$btnPanel.Controls.Add($closeButton); $btnPanel.Controls.Add($stopButton); $btnPanel.Controls.Add($deployButton)
$table.Controls.Add($btnPanel,0,6); $table.SetColumnSpan($btnPanel,3)

$status = New-Object System.Windows.Forms.StatusStrip
$stLabel = New-Object System.Windows.Forms.ToolStripStatusLabel; $stLabel.Text = "Ready"; $status.Items.Add($stLabel); $status.Dock = "Bottom"; $form.Controls.Add($status)

# globals
$global:uiLogBox = $logBox
$global:componentBox = $componentBox
$global:serviceBox = $serviceBox
$global:versionBox = $versionBox
$global:targetBox = $targetBox
$global:currentLogFile = $null
$global:deployThread = $null
$stopRequested = $false

# tooltips & dialogs
$tt = New-Object System.Windows.Forms.ToolTip
$tt.SetToolTip($componentBox,"Which component folder to deploy (affects service listing)")
$tt.SetToolTip($versionBox,"Artifact version (eg. 1.2.3 or 1.2.3-SNAPSHOT)")
$tt.SetToolTip($targetBox,"Target folder for this component on this server")
$folderBrowser = New-Object System.Windows.Forms.FolderBrowserDialog

$btnBrowseTarget.Add_Click({
    if ($folderBrowser.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        if (-not $targetBox.Items.Contains($folderBrowser.SelectedPath)) { $targetBox.Items.Add($folderBrowser.SelectedPath) | Out-Null }
        $targetBox.SelectedItem = $folderBrowser.SelectedPath
    }
})
$btnOpenFolder.Add_Click({
    if ($folderBrowser.ShowDialog() -eq [System.Windows.Forms.DialogResult]::OK) {
        $componentBox.Text = Split-Path $folderBrowser.SelectedPath -Leaf
    }
})
$btnExamples.Add_Click({
    [System.Windows.Forms.MessageBox]::Show("Examples:`r`n1.0.0`r`n1.0.0-SNAPSHOT`r`n2.5.1","Version examples",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Information)
})

# Populate service list
function Populate-ServiceList {
    $serviceBox.Items.Clear()
    $component = $componentBox.Text
    $path = if ($component -eq "style") { $defaultLocalPath } else { $defaultLocalPathApp }
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | ForEach-Object { [void]$serviceBox.Items.Add($_.Name) }
    }
    if ($serviceBox.Items.Count -eq 0) {
        Get-Service | Where-Object { $_.Name -like "*$component*" -or $_.DisplayName -like "*$component*" } | ForEach-Object { [void]$serviceBox.Items.Add($_.Name) }
    }
    if ($serviceBox.Items.Count -gt 0) { $serviceBox.SelectedIndex = 0 }
}
$btnRefresh.Add_Click({ Populate-ServiceList })
$componentBox.Add_SelectedIndexChanged({ Populate-ServiceList })
Populate-ServiceList

# Disable/Enable controls
function Disable-Controls($disabled) {
    $deployButton.Enabled = -not $disabled
    $stopButton.Enabled   = -not $disabled
    $componentBox.Enabled = -not $disabled
    $serviceBox.Enabled   = -not $disabled
    $versionBox.Enabled   = -not $disabled
    $targetBox.Enabled    = -not $disabled
}

# --- Deploy core (same logic as before) ---
function Deploy-WorkerCore {
    try {
        # immediate trace to disk so we see thread started
        Write-Log "THREAD: Deploy-WorkerCore entered (trace from thread)" $global:currentLogFile
        Safe-UIInvoke { $progressBar.Value = 5; $stLabel.Text = "Preparing..." }

        # (rest of deploy logic omitted here for brevity in this excerpt — use same logic as your previous Deploy-WorkerCore)
        # For full operation ensure the same download/copy logic from earlier script is present here.
        Start-Sleep -Seconds 1
        Write-Log "THREAD: Deploy-WorkerCore finished minimal demo" $global:currentLogFile
        Safe-UIInvoke { $stLabel.Text = "Completed"; Disable-Controls $false }
    } catch {
        Write-Log "Deploy worker unexpected: $($_.Exception.Message)`n$($_.Exception.StackTrace)" $global:currentLogFile
        Write-Fatal "Deploy worker unexpected: $($_.Exception.Message)"
        Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show("Deployment thread failed: $($_.Exception.Message)","Error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
        Safe-UIInvoke { $stLabel.Text = "Error"; Disable-Controls $false }
    }
}

# ---------- FIXED deploy button handler: robust delegate casting + try/catch ----------
$deployButton.Add_Click({
    if ($global:deployThread -and $global:deployThread.IsAlive) {
        Write-Log "Deploy clicked but thread already running." $global:currentLogFile
        return
    }

    $stopRequested = $false
    Disable-Controls $true
    Safe-UIInvoke { $stLabel.Text = "Queued..."; $progressBar.Value = 0 }
    Write-Log "Deploy requested - starting thread." $null

    try {
        # create a ThreadStart delegate from a scriptblock (safe casting)
        $sb = { Deploy-WorkerCore }
        $threadDelegate = [System.Threading.ThreadStart] $sb

        # create thread with that delegate
        $thr = New-Object System.Threading.Thread($threadDelegate)
        $thr.IsBackground = $true
        $global:deployThread = $thr

        # start thread
        $thr.Start()

        Write-Log "Thread.Start() invoked successfully." $global:currentLogFile
    } catch {
        # log and show message instead of letting the UI die
        $msg = "Failed to create/start thread: $($_.Exception.Message)"
        Write-Fatal $msg
        Write-Log $msg $global:currentLogFile
        Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show($msg,"Thread start error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
        Disable-Controls $false
        Safe-UIInvoke { $stLabel.Text = "Error" }
    }
})

# Stop button
$stopButton.Add_Click({
    if ($global:deployThread -and $global:deployThread.IsAlive) {
        $stopRequested = $true
        Write-Log "Stop requested (cooperative)" $global:currentLogFile
        Safe-UIInvoke { $stLabel.Text = "Stopping..." }
    } else {
        Write-Log "Stop clicked but no active thread" $global:currentLogFile
    }
})

$closeButton.Add_Click({ $form.Close() })

# top-level unhandled exception handler (unchanged)
[AppDomain]::CurrentDomain.add_UnhandledException({
    param($sender,$ea)
    try {
        $ex = $ea.ExceptionObject
        $msg = if ($ex -is [System.Exception]) { $ex.Message } else { $ex.ToString() }
        Write-Fatal "Unhandled exception: $msg"
        Safe-UIInvoke { [System.Windows.Forms.MessageBox]::Show("Fatal error: $msg","Fatal",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
    } catch {}
})

# show UI
$form.Add_Shown({ $form.Activate() })
$form.Topmost = $true
try { [void]$form.ShowDialog() } catch { Write-Fatal "ShowDialog threw: $($_.Exception.Message)"; [System.Windows.Forms.MessageBox]::Show("UI failed: $($_.Exception.Message) - see $logRoot\logs for details","UI Error",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Error) }
