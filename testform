Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Force TLS1.2 for downloads
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# ----------------- Configuration -----------------
$LocalStylePath  = "D:\Style"
$LocalAppStyle   = "D:\app\style"
$TargetTempDir   = "D:\Temp\deployments"
$BaseSnapshotUrl = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-snapshots-local/com/natwest/style"
$BaseReleaseUrl  = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-releases-local/com/natwest/style"
# -------------------------------------------------

function Ensure-Path {
    param([string]$p)
    if (-not (Test-Path $p)) {
        [void](New-Item -ItemType Directory -Force -Path $p)
    }
}

# ---------------- Build UI ----------------
$form = New-Object System.Windows.Forms.Form
$form.Text = "ðŸ”§  STYLE ARTIFACT DEPLOYMENT TOOL  ðŸ”§"
$form.Size = [System.Drawing.Size]::new(980, 680)
$form.MinimumSize = [System.Drawing.Size]::new(760, 480)
$form.StartPosition = "CenterScreen"
$form.BackColor = [System.Drawing.Color]::WhiteSmoke
$form.AutoScaleMode = [System.Windows.Forms.AutoScaleMode]::Dpi

$fontMain = New-Object System.Drawing.Font("Segoe UI",10)
$form.Font = $fontMain

# Bottom panel (status + buttons)
$bottomPanel = New-Object System.Windows.Forms.Panel
$bottomPanel.Height = 360
$bottomPanel.Dock = [System.Windows.Forms.DockStyle]::Bottom
$bottomPanel.Padding = [System.Windows.Forms.Padding]::new(8)
$bottomPanel.BackColor = [System.Drawing.Color]::FromArgb(250,250,250)
$form.Controls.Add($bottomPanel)

# Create status area inside bottomPanel (progress + logs)
$statusArea = New-Object System.Windows.Forms.Panel
$statusArea.Height = 300
$statusArea.Dock = [System.Windows.Forms.DockStyle]::Top
$statusArea.Padding = [System.Windows.Forms.Padding]::new(6)
$statusArea.BackColor = [System.Drawing.Color]::FromArgb(247,247,247)
$bottomPanel.Controls.Add($statusArea)

# content container fills the window (no internal header)
$contentPanel = New-Object System.Windows.Forms.Panel
$contentPanel.Dock = [System.Windows.Forms.DockStyle]::Fill
$contentPanel.Padding = [System.Windows.Forms.Padding]::new(8)
$form.Controls.Add($contentPanel)

# ---------------- Inputs table ----------------
$table = New-Object System.Windows.Forms.TableLayoutPanel
$table.Dock = [System.Windows.Forms.DockStyle]::Top
$table.AutoSize = $true
$table.AutoSizeMode = [System.Windows.Forms.AutoSizeMode]::GrowAndShrink
$table.ColumnCount = 2
$table.RowCount = 3
$table.Padding = [System.Windows.Forms.Padding]::new(6)

$labelColumnWidth = 300
$table.ColumnStyles.Clear()
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Absolute, $labelColumnWidth)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle([System.Windows.Forms.SizeType]::Percent, 100)))
for ($r = 0; $r -lt $table.RowCount; $r++) {
    $table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle([System.Windows.Forms.SizeType]::AutoSize)))
}
$contentPanel.Controls.Add($table)

function New-RightLabel($text) {
    $lbl = New-Object System.Windows.Forms.Label
    $lbl.Text = $text
    $lbl.AutoSize = $false
    $lbl.Width = $labelColumnWidth
    $lbl.TextAlign = [System.Drawing.ContentAlignment]::MiddleRight
    $lbl.Dock = [System.Windows.Forms.DockStyle]::Fill
    $lbl.Padding = [System.Windows.Forms.Padding]::new(0,4,12,4)
    $lbl.Font = $fontMain
    return $lbl
}

# Component
$lblComponent = New-RightLabel "Deployment Component"
$table.Controls.Add($lblComponent, 0, 0)
$componentBox = New-Object System.Windows.Forms.ComboBox
$componentBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$componentBox.Items.AddRange(@("style","style-ms"))
$componentBox.SelectedIndex = 0
$componentBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$componentBox.Margin = [System.Windows.Forms.Padding]::new(4)
$componentBox.Font = $fontMain
$table.Controls.Add($componentBox, 1, 0)

# Service
$lblService = New-RightLabel "Service Name"
$table.Controls.Add($lblService, 0, 1)
$serviceBox = New-Object System.Windows.Forms.ComboBox
$serviceBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$serviceBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$serviceBox.Margin = [System.Windows.Forms.Padding]::new(4)
$serviceBox.Font = $fontMain
$table.Controls.Add($serviceBox, 1, 1)

# Version
$lblVersion = New-RightLabel "Artifact Version"
$table.Controls.Add($lblVersion, 0, 2)
$versionHint = "e.g. 1.2.3 or 1.2.3-SNAPSHOT"
$versionBox = New-Object System.Windows.Forms.TextBox
$versionBox.Text = $versionHint
$versionBox.ForeColor = [System.Drawing.Color]::Gray
$versionBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$versionBox.Margin = [System.Windows.Forms.Padding]::new(4)
$versionBox.Font = $fontMain
$versionBox.Add_Enter({ if ($versionBox.Text -eq $versionHint) { $versionBox.Text = ""; $versionBox.ForeColor = [System.Drawing.Color]::Black } })
$versionBox.Add_Leave({ if ([string]::IsNullOrWhiteSpace($versionBox.Text)) { $versionBox.Text = $versionHint; $versionBox.ForeColor = [System.Drawing.Color]::Gray } })
$table.Controls.Add($versionBox, 1, 2)

# small spacer + flexible filler
$spacer = New-Object System.Windows.Forms.Panel
$spacer.Height = 12
$spacer.Dock = [System.Windows.Forms.DockStyle]::Top
$contentPanel.Controls.Add($spacer)
$filler = New-Object System.Windows.Forms.Panel
$filler.Dock = [System.Windows.Forms.DockStyle]::Fill
$contentPanel.Controls.Add($filler)

# ---------------- Status area controls ----------------
$progressPanel = New-Object System.Windows.Forms.Panel
$progressPanel.Dock = [System.Windows.Forms.DockStyle]::Top
$progressPanel.Padding = [System.Windows.Forms.Padding]::new(4)
$progressPanel.Height = 28
$statusArea.Controls.Add($progressPanel)
$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Dock = [System.Windows.Forms.DockStyle]::Fill
$progressPanel.Controls.Add($progressBar)

$logPanel = New-Object System.Windows.Forms.Panel
$logPanel.Dock = [System.Windows.Forms.DockStyle]::Fill
$logPanel.Padding = [System.Windows.Forms.Padding]::new(4)
$statusArea.Controls.Add($logPanel)
$logBox = New-Object System.Windows.Forms.TextBox
$logBox.Multiline = $true
$logBox.ScrollBars = "Vertical"
$logBox.ReadOnly = $true
$logBox.WordWrap = $false
$logBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$logBox.Font = $fontMain
$logPanel.Controls.Add($logBox)

# Buttons area inside bottomPanel
$buttonsPanel = New-Object System.Windows.Forms.Panel
$buttonsPanel.Height = 60
$buttonsPanel.Dock = [System.Windows.Forms.DockStyle]::Bottom
$buttonsPanel.Padding = [System.Windows.Forms.Padding]::new(6)
$bottomPanel.Controls.Add($buttonsPanel)
$openLogsBtn = New-Object System.Windows.Forms.Button
$openLogsBtn.Text = "Open Logs"
$openLogsBtn.Size = [System.Drawing.Size]::new(110,36)
$openLogsBtn.Location = [System.Drawing.Point]::new(12, 12)
$openLogsBtn.Font = $fontMain
$buttonsPanel.Controls.Add($openLogsBtn)
$deployButton = New-Object System.Windows.Forms.Button
$deployButton.Text = "Deploy"
$deployButton.Size = [System.Drawing.Size]::new(140,40)
$deployButton.Font = New-Object System.Drawing.Font("Segoe UI",11,[System.Drawing.FontStyle]::Bold)
$buttonsPanel.Controls.Add($deployButton)
$placeButtons = {
    $padding = 12
    $deployButton.Left = $buttonsPanel.ClientSize.Width - $deployButton.Width - $padding
    $deployButton.Top  = [int](($buttonsPanel.ClientSize.Height - $deployButton.Height)/2)
    $openLogsBtn.Top   = [int](($buttonsPanel.ClientSize.Height - $openLogsBtn.Height)/2)
}
& $placeButtons
$buttonsPanel.Add_Resize({ & $placeButtons })

# ---------------- Logging helpers (fixed Invoke usage) ----------------
function Append-LogToUI {
    param([string]$text)
    $action = {
        param($t)
        if ($logBox -and $logBox.IsHandleCreated) {
            $logBox.AppendText(("[" + (Get-Date -Format 'yyyy-MM-dd HH:mm:ss') + "] " + $t + "`r`n"))
            $logBox.SelectionStart = $logBox.Text.Length
            $logBox.ScrollToCaret()
        } else {
            Write-Host $t
        }
    }

    try {
        if ($logBox -and $logBox.IsHandleCreated -and -not $logBox.InvokeRequired) {
            & $action $text
        } elseif ($form -and $form.IsHandleCreated) {
            # pass arguments as array
            $form.Invoke($action, @($text)) | Out-Null
        } else {
            Write-Host $text
        }
    } catch {
        try { $form.BeginInvoke($action, @($text)) | Out-Null } catch { Write-Host "Append-Log failed: $_" }
    }
}

function Write-Log {
    param([string]$message, [string]$logFilePath)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $entry = "[$timestamp] $message"
    Append-LogToUI $message
    try {
        Ensure-Path (Split-Path $logFilePath -Parent)
        [void](Add-Content -Path $logFilePath -Value $entry -ErrorAction Stop)
    } catch {
        Append-LogToUI "ERROR writing to $logFilePath : $_"
    }
}

# ---------------- Populate service list ----------------
$componentBox.Add_SelectedIndexChanged({
    $serviceBox.Items.Clear()
    $path = if ($componentBox.SelectedItem -eq "style") { $LocalStylePath } else { $LocalAppStyle }
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue |
            ForEach-Object { [void]$serviceBox.Items.Add($_.Name) }
        if ($serviceBox.Items.Count -gt 0) { $serviceBox.SelectedIndex = 0 }
    } else {
        Append-LogToUI "Component folder not found: $path"
    }
})
$componentBox.SelectedIndex = 0

# ---------------- BackgroundWorker (returns structured result) ----------------
$bw = New-Object System.ComponentModel.BackgroundWorker
$bw.WorkerReportsProgress = $true
$bw.WorkerSupportsCancellation = $true

$bw.add_DoWork({
    param($sender, $e)
    try {
        $component        = $e.Argument.Component
        $artifact_name    = $e.Argument.Artifact
        $artifact_version = $e.Argument.Version
        $logFile          = $e.Argument.LogFile

        $report = {
            param($pct, $msg)
            $sender.ReportProgress($pct, $msg)
            Write-Log -message $msg -logFilePath $logFile
        }

        & $report 10 "Starting deployment..."

        # Prepare URL
        $isSnapshot = $artifact_version -like "*SNAPSHOT*"
        if ($isSnapshot) {
            $url = "$BaseSnapshotUrl/$artifact_name/$artifact_version/$artifact_name-$artifact_version.jar"
        } else {
            $url = "$BaseReleaseUrl/$artifact_name/$artifact_version/$artifact_name-$artifact_version.jar"
        }
        & $report 20 "Constructed URL: $url"

        Ensure-Path $TargetTempDir
        $targetDir   = $TargetTempDir
        $logDir      = Join-Path $targetDir "logs"
        $dateFolder  = Join-Path $logDir (Get-Date -Format "yyyy-MM-dd")
        $artifactFile = "$artifact_name-$artifact_version.jar"
        $artifactPath = Join-Path $targetDir $artifactFile
        Ensure-Path $logDir; Ensure-Path $dateFolder

        try {
            & $report 35 "Downloading artifact..."
            Invoke-WebRequest -Uri $url -OutFile $artifactPath -UseBasicParsing -ErrorAction Stop
            & $report 55 "Downloaded to $artifactPath"
        } catch {
            $err = $_.Exception
            & $report 0 "Download failed: $($err.Message)"
            $e.Result = @{
                Success    = $false
                Error      = "Download failed: $($err.Message)"
                StackTrace = $err.StackTrace
            }
            return
        }

        & $report 60 "Verifying deployment folder..."
        $deployPath = if ($component -eq "style") { Join-Path $LocalStylePath $artifact_name } else { Join-Path $LocalAppStyle $artifact_name }
        if (-not (Test-Path $deployPath)) {
            & $report 0 "Deployment folder not found: $deployPath"
            $e.Result = @{ Success = $false; Error = "Deployment folder not found: $deployPath"; StackTrace = "" }
            return
        }

        & $report 70 "Removing existing artifact (if present)..."
        try {
            $existingJar = Join-Path $deployPath "$artifact_name.jar"
            if (Test-Path $existingJar) {
                Remove-Item $existingJar -Force -ErrorAction Stop
                & $report 80 "Removed existing jar: $existingJar"
            } else {
                & $report 80 "No existing jar found."
            }

            $newJarPath = Join-Path $deployPath "$artifact_name.jar"
            Copy-Item -Path $artifactPath -Destination $newJarPath -Force -ErrorAction Stop
            & $report 95 "Copied new artifact to: $newJarPath"
        } catch {
            $err = $_.Exception
            & $report 0 "Deployment file operation failed: $($err.Message)"
            $e.Result = @{
                Success    = $false
                Error      = "Deployment file operation failed: $($err.Message)"
                StackTrace = $err.StackTrace
            }
            return
        }

        & $report 100 "Deployment completed successfully."
        $e.Result = @{ Success = $true }
    } catch {
        $err = $_.Exception
        $e.Result = @{
            Success    = $false
            Error      = $err.Message
            StackTrace = $err.StackTrace
        }
    }
})

# ProgressChanged runs on UI thread
$bw.add_ProgressChanged({
    param($s, $args)
    try {
        if ($args.UserState) { Append-LogToUI $args.UserState }
        $progressBar.Value = [int]$args.ProgressPercentage
    } catch {
        Append-LogToUI "ProgressChanged handler error: $_"
    }
})

# RunWorkerCompleted shows detailed errors if present
$bw.add_RunWorkerCompleted({
    param($s, $args)
    try {
        if ($args.Cancelled) {
            Append-LogToUI "Deployment cancelled."
            $progressBar.Value = 0
            [System.Windows.Forms.MessageBox]::Show("Deployment cancelled.", "Cancelled", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information) | Out-Null
        } elseif ($args.Error) {
            Append-LogToUI "Unhandled background exception: $($args.Error.Message)"
            if ($args.Error.StackTrace) { Append-LogToUI $args.Error.StackTrace }
            $progressBar.Value = 0
            [System.Windows.Forms.MessageBox]::Show("Deployment failed with an unhandled exception:`n" + $args.Error.Message, "Error", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error) | Out-Null
        } elseif ($args.Result -and $args.Result.Success) {
            Append-LogToUI "Deployment finished successfully."
            $progressBar.Value = 100
            [System.Windows.Forms.MessageBox]::Show("Deployment finished successfully.", "Success", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Information) | Out-Null
        } else {
            # Show detailed failure info
            if ($args.Result -and $args.Result.Error) {
                $errMsg = $args.Result.Error
                $stack  = $args.Result.StackTrace
                Append-LogToUI "Deployment failed: $errMsg"
                if ($stack) { Append-LogToUI "StackTrace:`n$stack" }
                $progressBar.Value = 0

                # show a short popup, include more details in the log
                $short = if ($errMsg.Length -gt 300) { $errMsg.Substring(0,300) + "..." } else { $errMsg }
                [System.Windows.Forms.MessageBox]::Show("Deployment failed:`n$short", "Deployment failed", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error) | Out-Null
            } else {
                Append-LogToUI "Deployment failed: unknown error"
                $progressBar.Value = 0
                [System.Windows.Forms.MessageBox]::Show("Deployment failed: unknown error. See log for details.", "Deployment failed", [System.Windows.Forms.MessageBoxButtons]::OK, [System.Windows.Forms.MessageBoxIcon]::Error) | Out-Null
            }
        }
    } catch {
        Append-LogToUI "RunWorkerCompleted handler error: $_"
    } finally {
        $deployButton.Enabled = $true
    }
})

# ---------------- Buttons ----------------
$deployButton.Add_Click({
    try {
        $component        = $componentBox.SelectedItem
        $artifact_name    = $serviceBox.SelectedItem
        $artifact_version = $versionBox.Text.Trim()
        if ($artifact_version -eq $versionHint) { $artifact_version = "" }

        if (-not ($component -and $artifact_name -and $artifact_version)) {
            [System.Windows.Forms.MessageBox]::Show("Please fill all fields (component, service, version).","Missing fields",[System.Windows.Forms.MessageBoxButtons]::OK,[System.Windows.Forms.MessageBoxIcon]::Exclamation)
            return
        }

        $logDir     = Join-Path $TargetTempDir "logs"
        $dateFolder = Join-Path $logDir (Get-Date -Format "yyyy-MM-dd")
        Ensure-Path $dateFolder
        $logFile    = Join-Path $dateFolder "${artifact_name}-${artifact_version}.log"

        $deployButton.Enabled = $false
        $progressBar.Value = 5
        Write-Log "Starting deployment..." $logFile

        $args = @{
            Component = $component
            Artifact  = $artifact_name
            Version   = $artifact_version
            LogFile   = $logFile
        }
        $bw.RunWorkerAsync($args)
    } catch {
        Append-LogToUI "Deploy button error: $_"
        $deployButton.Enabled = $true
    }
})

$openLogsBtn.Add_Click({
    try {
        $todayFolder = Join-Path $TargetTempDir "logs"
        $todayFolder = Join-Path $todayFolder (Get-Date -Format "yyyy-MM-dd")
        Ensure-Path $todayFolder
        Start-Process explorer -ArgumentList $todayFolder
    } catch {
        Append-LogToUI "Open logs error: $_"
    }
})

# ---------------- Startup ----------------
Append-LogToUI "UI ready. Select component and service, enter version, then click Deploy."
$form.Topmost = $true
[void]$form.ShowDialog()
