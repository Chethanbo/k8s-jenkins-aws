Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Robust MessageBox wrapper (safe in all contexts)
function Show-Dialog {
    param(
        [string]$Message = "No message was provided.",
        [string]$Title = "",
        [object]$Buttons = [System.Windows.Forms.MessageBoxButtons]::OK,
        [object]$Icon = [System.Windows.Forms.MessageBoxIcon]::None
    )
    try {
        function Convert-ToEnum { param($v,[Type]$t,$fb) 
            try { if ($null -eq $v) { return $fb }; if ($v -is $t) { return $v }; if ($v -is [int]) { return [Enum]::ToObject($t,[int]$v) }; return [Enum]::Parse($t,$v.ToString(),$true) } catch { return $fb }
        }
        $btn = Convert-ToEnum $Buttons ([System.Windows.Forms.MessageBoxButtons]) [System.Windows.Forms.MessageBoxButtons]::OK
        $icon = Convert-ToEnum $Icon ([System.Windows.Forms.MessageBoxIcon]) [System.Windows.Forms.MessageBoxIcon]::None
        [System.Windows.Forms.MessageBox]::Show($Message,$Title,$btn,$icon) | Out-Null
    } catch {
        # worst-case fallback
        [System.Windows.Forms.MessageBox]::Show($Message) | Out-Null
    }
}

# Force TLS1.2 for web requests
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# ---------------- Configuration ----------------
$LocalStylePath  = "D:\Style"
$LocalAppStyle   = "D:\app\style"
$TargetTempDir   = "D:\Temp\deployments"
$BaseSnapshotUrl = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-snapshots-local/com/natwest/style"
$BaseReleaseUrl  = "https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-releases-local/com/natwest/style"

function Ensure-Path { param($p) if (-not (Test-Path $p)) { New-Item -Path $p -ItemType Directory -Force | Out-Null } }

# ---------------- Build simple UI ----------------
$form = New-Object System.Windows.Forms.Form
$form.Text = "STYLE ARTIFACT DEPLOYMENT TOOL"
$form.Size = [System.Drawing.Size]::new(820,520)
$form.StartPosition = "CenterScreen"
$form.BackColor = [System.Drawing.Color]::WhiteSmoke
$form.Font = New-Object System.Drawing.Font("Segoe UI",10)

$leftMargin = 16
$labelWidth = 180
$inputWidth = 520
$topBase = 18
$gapY = 42

# Labels
$lblComponent = New-Object System.Windows.Forms.Label
$lblComponent.Text = "Deployment Component"
$lblComponent.Location = [System.Drawing.Point]::new($leftMargin, $topBase)
$lblComponent.AutoSize = $false
$lblComponent.Size = [System.Drawing.Size]::new($labelWidth,24)
$lblComponent.TextAlign = [System.Drawing.ContentAlignment]::MiddleRight
$form.Controls.Add($lblComponent)

$lblService = New-Object System.Windows.Forms.Label
$lblService.Text = "Service Name"
$lblService.Location = [System.Drawing.Point]::new($leftMargin, $topBase + $gapY)
$lblService.AutoSize = $false
$lblService.Size = [System.Drawing.Size]::new($labelWidth,24)
$lblService.TextAlign = [System.Drawing.ContentAlignment]::MiddleRight
$form.Controls.Add($lblService)

$lblVersion = New-Object System.Windows.Forms.Label
$lblVersion.Text = "Artifact Version"
$lblVersion.Location = [System.Drawing.Point]::new($leftMargin, $topBase + ($gapY*2))
$lblVersion.AutoSize = $false
$lblVersion.Size = [System.Drawing.Size]::new($labelWidth,24)
$lblVersion.TextAlign = [System.Drawing.ContentAlignment]::MiddleRight
$form.Controls.Add($lblVersion)

# Inputs
$inputLeft = $leftMargin + $labelWidth + 8

$componentBox = New-Object System.Windows.Forms.ComboBox
$componentBox.Location = [System.Drawing.Point]::new($inputLeft, $topBase)
$componentBox.Size = [System.Drawing.Size]::new($inputWidth,28)
$componentBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$componentBox.Items.AddRange(@("style","style-ms"))
$componentBox.SelectedIndex = 0
$form.Controls.Add($componentBox)

$serviceBox = New-Object System.Windows.Forms.ComboBox
$serviceBox.Location = [System.Drawing.Point]::new($inputLeft, $topBase + $gapY)
$serviceBox.Size = [System.Drawing.Size]::new($inputWidth,28)
$serviceBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$form.Controls.Add($serviceBox)

$versionHint = "e.g. 1.2.3 or 1.2.3-SNAPSHOT"
$versionBox = New-Object System.Windows.Forms.TextBox
$versionBox.Location = [System.Drawing.Point]::new($inputLeft, $topBase + ($gapY*2))
$versionBox.Size = [System.Drawing.Size]::new($inputWidth,28)
$versionBox.Text = $versionHint
$versionBox.ForeColor = [System.Drawing.Color]::Gray
$versionBox.Add_Enter({ if ($versionBox.Text -eq $versionHint) { $versionBox.Text=''; $versionBox.ForeColor = [System.Drawing.Color]::Black } })
$versionBox.Add_Leave({ if ([string]::IsNullOrWhiteSpace($versionBox.Text)) { $versionBox.Text = $versionHint; $versionBox.ForeColor = [System.Drawing.Color]::Gray } })
$form.Controls.Add($versionBox)

# Populate service list when component changes
$componentBox.Add_SelectedIndexChanged({
    $serviceBox.Items.Clear()
    $path = if ($componentBox.SelectedItem -eq "style") { $LocalStylePath } else { $LocalAppStyle }
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            $serviceBox.Items.Add($_.Name) | Out-Null
        }
    }
    if ($serviceBox.Items.Count -gt 0) { $serviceBox.SelectedIndex = 0 }
})
# run once to populate
$componentBox.SelectedIndex = 0

# Progress and log area
$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Location = [System.Drawing.Point]::new($leftMargin, $topBase + ($gapY*3) + 8)
$progressBar.Size = [System.Drawing.Size]::new($labelWidth + $inputWidth + 8,18)
$form.Controls.Add($progressBar)

$logTop = $topBase + ($gapY*3) + 36
$logHeight = 300
$logBox = New-Object System.Windows.Forms.TextBox
$logBox.Location = [System.Drawing.Point]::new($leftMargin, $logTop)
$logBox.Size = [System.Drawing.Size]::new($labelWidth + $inputWidth + 8, $logHeight)
$logBox.Multiline = $true
$logBox.ScrollBars = "Vertical"
$logBox.ReadOnly = $true
$form.Controls.Add($logBox)

# ---------------- Buttons panel (fixed bottom) ----------------
$buttonsPanel = New-Object System.Windows.Forms.Panel
$buttonsPanel.Height = 56
$buttonsPanel.Dock = [System.Windows.Forms.DockStyle]::Bottom
$buttonsPanel.Padding = [System.Windows.Forms.Padding]::new(8)
$buttonsPanel.BackColor = [System.Drawing.Color]::FromArgb(245,245,245)
$form.Controls.Add($buttonsPanel)

$openLogsBtn = New-Object System.Windows.Forms.Button
$openLogsBtn.Text = "Open Logs"
$openLogsBtn.Size = [System.Drawing.Size]::new(120,36)
$openLogsBtn.Left = 12
$openLogsBtn.Top = 10
$openLogsBtn.Anchor = [System.Windows.Forms.AnchorStyles]::Left
$buttonsPanel.Controls.Add($openLogsBtn)

$deployButton = New-Object System.Windows.Forms.Button
$deployButton.Text = "Deploy"
$deployButton.Size = [System.Drawing.Size]::new(140,40)
$deployButton.Font = New-Object System.Drawing.Font("Segoe UI",11,[System.Drawing.FontStyle]::Bold)
# position to right side inside panel
$deployButton.Anchor = [System.Windows.Forms.AnchorStyles]::Right
$deployButton.Left = $buttonsPanel.ClientSize.Width - $deployButton.Width - 12
$deployButton.Top  = [int](($buttonsPanel.ClientSize.Height - $deployButton.Height)/2)
$buttonsPanel.Controls.Add($deployButton)

# reposition on resize so it stays at right
$buttonsPanel.Add_Resize({
    $deployButton.Left = $buttonsPanel.ClientSize.Width - $deployButton.Width - 12
    $deployButton.Top  = [int](($buttonsPanel.ClientSize.Height - $deployButton.Height)/2)
})

# Logging helper
function Append-Log {
    param([string]$message)
    $ts = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $entry = "[$ts] $message`r`n"
    if ($logBox.InvokeRequired) {
        $logBox.Invoke([Action]{ $logBox.AppendText($entry) }) | Out-Null
    } else {
        $logBox.AppendText($entry)
    }
}

# ---------------- Deployment (synchronous) ----------------
$deployButton.Add_Click({
    try {
        $component = $componentBox.SelectedItem
        $artifact  = $serviceBox.SelectedItem
        $version   = $versionBox.Text.Trim()
        if ($version -eq $versionHint) { $version = "" }

        if (-not ($component -and $artifact -and $version)) {
            Show-Dialog "Please fill all fields." "Validation Error" [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Warning
            return
        }

        $targetDir   = $TargetTempDir
        $logDir      = Join-Path $targetDir "logs"
        $dateFolder  = Join-Path $logDir (Get-Date -Format "yyyy-MM-dd")
        Ensure-Path $targetDir; Ensure-Path $logDir; Ensure-Path $dateFolder

        $logFile = Join-Path $dateFolder "$artifact-$version.log"

        Append-Log "Starting deployment..."
        Append-Log "Component: $component, Service: $artifact, Version: $version"

        $isSnapshot = $version -like "*SNAPSHOT*"
        if ($isSnapshot) {
            $url = "$BaseSnapshotUrl/$artifact/$version/$artifact-$version.jar"
        } else {
            $url = "$BaseReleaseUrl/$artifact/$version/$artifact-$version.jar"
        }

        Append-Log "Constructed URL: $url"
        $progressBar.Value = 10

        $artifactPath = Join-Path $targetDir "$artifact-$version.jar"

        try {
            Invoke-WebRequest -Uri $url -OutFile $artifactPath -UseBasicParsing -ErrorAction Stop
            Append-Log "Downloaded artifact to $artifactPath"
            $progressBar.Value = 50
        } catch {
            Append-Log "Download failed: $($_.Exception.Message)"
            Add-Content -Path $logFile -Value ("[" + (Get-Date) + "] Download failed: " + $_.Exception.Message)
            Show-Dialog "Download failed: $($_.Exception.Message)" "Error" [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
            return
        }

        $deployPath = if ($component -eq "style") { Join-Path $LocalStylePath $artifact } else { Join-Path $LocalAppStyle $artifact }
        Append-Log "Deploy folder: $deployPath"

        if (-not (Test-Path $deployPath)) {
            Append-Log "Deployment folder not found: $deployPath"
            Add-Content -Path $logFile -Value ("[" + (Get-Date) + "] Deployment folder not found: " + $deployPath)
            Show-Dialog "Deployment folder not found: $deployPath" "Error" [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
            return
        }

        $existingJar = Join-Path $deployPath "$artifact.jar"
        if (Test-Path $existingJar) {
            Remove-Item $existingJar -Force
            Append-Log "Removed existing jar: $existingJar"
        } else {
            Append-Log "No existing jar to remove."
        }

        Copy-Item -Path $artifactPath -Destination $existingJar -Force
        Append-Log "Copied new artifact to $existingJar"
        $progressBar.Value = 100

        Add-Content -Path $logFile -Value ("[" + (Get-Date) + "] Deployment completed successfully.")
        Append-Log "Deployment completed successfully."
        Show-Dialog "Deployment completed successfully." "Success" [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Information
    } catch {
        Append-Log "Unhandled error: $($_.Exception.Message)"
        Show-Dialog "Unhandled error: $($_.Exception.Message)" "Error" [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
    }
})

$openLogsBtn.Add_Click({
    $folder = Join-Path (Join-Path $TargetTempDir "logs") (Get-Date -Format "yyyy-MM-dd")
    Ensure-Path $folder
    Start-Process explorer.exe $folder
})

# Show the form
$form.Topmost = $true
[void]$form.ShowDialog()
