Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# Robust MessageBox wrapper
function Show-Dialog {
    param(
        [Parameter(Position=0)] [string] $Message = 'No message was provided.',
        [Parameter(Position=1)] [string] $Title = '',
        [Parameter(Position=2)] [object] $Buttons = [System.Windows.Forms.MessageBoxButtons]::OK,
        [Parameter(Position=3)] [object] $Icon = [System.Windows.Forms.MessageBoxIcon]::None
    )
    if ([string]::IsNullOrWhiteSpace($Message)) { $Message = 'No message was provided.' }
    function Convert-ToEnum { param($v,[Type]$t,$fb) try { if ($null -eq $v) { $fb } elseif ($v -is $t) { $v } elseif ($v -is [int]) { [Enum]::ToObject($t,$v) } else { [Enum]::Parse($t,$v.ToString(),$true) } } catch { $fb } }
    $btn = Convert-ToEnum $Buttons ([System.Windows.Forms.MessageBoxButtons]) [System.Windows.Forms.MessageBoxButtons]::OK
    $icon = Convert-ToEnum $Icon ([System.Windows.Forms.MessageBoxIcon]) [System.Windows.Forms.MessageBoxIcon]::None
    [System.Windows.Forms.MessageBox]::Show($Message,$Title,$btn,$icon) | Out-Null
}

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Paths & preserved deployment config
$LocalStylePath  = 'D:\Style'
$LocalAppStyle   = 'D:\app\style'
$TargetTempDir   = 'D:\Temp\deployments'
$BaseSnapshotUrl = 'https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-snapshots-local/com/natwest/style'
$BaseReleaseUrl  = 'https://artifactory-server.app.bankwvcs.net/artifactory/pcot-style-libs-releases-local/com/natwest/style'
function Ensure-Path { param($p) if (-not (Test-Path $p)) { New-Item -Path $p -ItemType Directory -Force | Out-Null } }

# Main form
$form = New-Object System.Windows.Forms.Form
$form.Text = 'Style Artifact Deployment Tool'
$form.Size = [System.Drawing.Size]::new(980,640)
$form.MinimumSize = [System.Drawing.Size]::new(880,520)
$form.StartPosition = 'CenterScreen'
$form.BackColor = [System.Drawing.Color]::FromArgb(250,250,250)
$form.Font = New-Object System.Drawing.Font('Segoe UI',10)

# Accent color used for buttons
$accent = [System.Drawing.Color]::FromArgb(37,99,235)

# Header (top)
$header = New-Object System.Windows.Forms.Panel
$header.Height = 72
$header.Dock = [System.Windows.Forms.DockStyle]::Top
$header.BackColor = [System.Drawing.Color]::White
$header.Padding = [System.Windows.Forms.Padding]::new(12)
$form.Controls.Add($header)

$lblTitle = New-Object System.Windows.Forms.Label
$lblTitle.Text = 'Style Artifact Deployment'
$lblTitle.Font = New-Object System.Drawing.Font('Segoe UI',18,[System.Drawing.FontStyle]::Bold)
$lblTitle.AutoSize = $false
$lblTitle.TextAlign = [System.Drawing.ContentAlignment]::MiddleLeft
$lblTitle.Dock = [System.Windows.Forms.DockStyle]::Left
$lblTitle.Width = 560
$header.Controls.Add($lblTitle)

$lblSub = New-Object System.Windows.Forms.Label
$lblSub.Text = 'Select component, choose service and enter version. Logs appear below.'
$lblSub.Font = New-Object System.Drawing.Font('Segoe UI',9,[System.Drawing.FontStyle]::Regular)
$lblSub.AutoSize = $false
$lblSub.TextAlign = [System.Drawing.ContentAlignment]::MiddleLeft
$lblSub.Dock = [System.Windows.Forms.DockStyle]::Fill
$header.Controls.Add($lblSub)

# Main content: inputs (left) and status (right)
$main = New-Object System.Windows.Forms.Panel
$main.Dock = [System.Windows.Forms.DockStyle]::Top
$main.Height = 200
$main.Padding = [System.Windows.Forms.Padding]::new(12)
$form.Controls.Add($main)

# Left inputs container (TableLayoutPanel)
$left = New-Object System.Windows.Forms.Panel
$left.Width = 560
$left.Dock = [System.Windows.Forms.DockStyle]::Left
$main.Controls.Add($left)

$table = New-Object System.Windows.Forms.TableLayoutPanel
$table.Dock = [System.Windows.Forms.DockStyle]::Fill
$table.ColumnCount = 2
$table.RowCount = 4
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle('Absolute',190)))
$table.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle('Percent',100)))
$table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',44)))
$table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',44)))
$table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',44)))
$table.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Percent',100)))
$left.Controls.Add($table)

function MakeLabel($text) {
    $l = New-Object System.Windows.Forms.Label
    $l.Text = $text
    $l.TextAlign = [System.Drawing.ContentAlignment]::MiddleRight
    $l.Dock = [System.Windows.Forms.DockStyle]::Fill
    $l.Margin = [System.Windows.Forms.Padding]::new(6,0,6,0)
    return $l
}

# Component label & combo
$table.Controls.Add((MakeLabel 'Deployment Component'),0,0)
$componentBox = New-Object System.Windows.Forms.ComboBox
$componentBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$componentBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$componentBox.Items.AddRange(@('style','style-ms'))
$componentBox.Margin = [System.Windows.Forms.Padding]::new(6,8,6,8)
$componentBox.DropDownWidth = 420
$table.Controls.Add($componentBox,1,0)

# Service label & combo
$table.Controls.Add((MakeLabel 'Service Name'),0,1)
$serviceBox = New-Object System.Windows.Forms.ComboBox
$serviceBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$serviceBox.DropDownStyle = [System.Windows.Forms.ComboBoxStyle]::DropDownList
$serviceBox.Margin = [System.Windows.Forms.Padding]::new(6,8,6,8)
$serviceBox.DropDownWidth = 420
$table.Controls.Add($serviceBox,1,1)

# Version label & text box
$table.Controls.Add((MakeLabel 'Artifact Version'),0,2)
$versionHint = 'e.g. 1.2.3 or 1.2.3-SNAPSHOT'
$versionBox = New-Object System.Windows.Forms.TextBox
$versionBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$versionBox.Text = $versionHint
$versionBox.ForeColor = [System.Drawing.Color]::Gray
$versionBox.Margin = [System.Windows.Forms.Padding]::new(6,8,6,8)
$versionBox.Add_Enter({ if ($versionBox.Text -eq $versionHint) { $versionBox.Text=''; $versionBox.ForeColor = [System.Drawing.Color]::Black } })
$versionBox.Add_Leave({ if ([string]::IsNullOrWhiteSpace($versionBox.Text)) { $versionBox.Text = $versionHint; $versionBox.ForeColor = [System.Drawing.Color]::Gray } })
$table.Controls.Add($versionBox,1,2)

# small spacer row keeps layout tidy
$spacer = New-Object System.Windows.Forms.Panel
$spacer.Dock = [System.Windows.Forms.DockStyle]::Fill
$table.Controls.Add($spacer,0,3)
$table.SetColumnSpan($spacer,2)

# Right status card (compact)
$right = New-Object System.Windows.Forms.Panel
$right.Dock = [System.Windows.Forms.DockStyle]::Fill
$right.Padding = [System.Windows.Forms.Padding]::new(12)
$main.Controls.Add($right)

$statusCard = New-Object System.Windows.Forms.Panel
$statusCard.BackColor = [System.Drawing.Color]::White
$statusCard.BorderStyle = [System.Windows.Forms.BorderStyle]::FixedSingle
$statusCard.Dock = [System.Windows.Forms.DockStyle]::Top
$statusCard.Height = 180
$statusCard.Padding = [System.Windows.Forms.Padding]::new(10)
$right.Controls.Add($statusCard)

$stTitle = New-Object System.Windows.Forms.Label
$stTitle.Text = 'Status'
$stTitle.Font = New-Object System.Drawing.Font('Segoe UI',12,[System.Drawing.FontStyle]::Bold)
$stTitle.Dock = [System.Windows.Forms.DockStyle]::Top
$statusCard.Controls.Add($stTitle)

$info = New-Object System.Windows.Forms.TableLayoutPanel
$info.Dock = [System.Windows.Forms.DockStyle]::Top
$info.ColumnCount = 2
$info.RowCount = 3
$info.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle('Absolute',110)))
$info.ColumnStyles.Add((New-Object System.Windows.Forms.ColumnStyle('Percent',100)))
$info.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',28)))
$info.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',28)))
$info.RowStyles.Add((New-Object System.Windows.Forms.RowStyle('Absolute',28)))
$statusCard.Controls.Add($info)

$lbl1 = New-Object System.Windows.Forms.Label; $lbl1.Text='Component:'; $lbl1.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft
$lbl2 = New-Object System.Windows.Forms.Label; $lbl2.Text='Service:';    $lbl2.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft
$lbl3 = New-Object System.Windows.Forms.Label; $lbl3.Text='Version:';    $lbl3.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft
$val1 = New-Object System.Windows.Forms.Label; $val1.Text='—'; $val1.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft
$val2 = New-Object System.Windows.Forms.Label; $val2.Text='—'; $val2.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft
$val3 = New-Object System.Windows.Forms.Label; $val3.Text='—'; $val3.TextAlign=[System.Drawing.ContentAlignment]::MiddleLeft

$info.Controls.Add($lbl1,0,0); $info.Controls.Add($val1,1,0)
$info.Controls.Add($lbl2,0,1); $info.Controls.Add($val2,1,1)
$info.Controls.Add($lbl3,0,2); $info.Controls.Add($val3,1,2)

# Progress and percent label
$progPanel = New-Object System.Windows.Forms.Panel
$progPanel.Dock = [System.Windows.Forms.DockStyle]::Bottom
$progPanel.Height = 56
$statusCard.Controls.Add($progPanel)

$progressBar = New-Object System.Windows.Forms.ProgressBar
$progressBar.Style = [System.Windows.Forms.ProgressBarStyle]::Continuous
$progressBar.Value = 0
$progressBar.Width = 340
$progressBar.Height = 18
$progressBar.Left = 6
$progressBar.Top = 8
$progPanel.Controls.Add($progressBar)

$percentLabel = New-Object System.Windows.Forms.Label
$percentLabel.Text = '0%'
$percentLabel.Left = $progressBar.Right + 12
$percentLabel.Top = $progressBar.Top - 2
$percentLabel.AutoSize = $true
$progPanel.Controls.Add($percentLabel)

# Log panel below everything (full-width)
$logPanel = New-Object System.Windows.Forms.Panel
$logPanel.Dock = [System.Windows.Forms.DockStyle]::Fill
$logPanel.Padding = [System.Windows.Forms.Padding]::new(12)
$form.Controls.Add($logPanel)

$logBox = New-Object System.Windows.Forms.TextBox
$logBox.Multiline = $true
$logBox.ScrollBars = 'Vertical'
$logBox.ReadOnly = $true
$logBox.Dock = [System.Windows.Forms.DockStyle]::Fill
$logPanel.Controls.Add($logBox)

# Buttons panel (fixed bottom)
$buttons = New-Object System.Windows.Forms.Panel
$buttons.Dock = [System.Windows.Forms.DockStyle]::Bottom
$buttons.Height = 64
$buttons.Padding = [System.Windows.Forms.Padding]::new(12)
$buttons.BackColor = [System.Drawing.Color]::FromArgb(245,245,245)
$form.Controls.Add($buttons)

$openBtn = New-Object System.Windows.Forms.Button
$openBtn.Text = 'Open Logs'
$openBtn.Width = 120
$openBtn.Height = 40
$openBtn.FlatStyle = [System.Windows.Forms.FlatStyle]::System
$buttons.Controls.Add($openBtn)

$deployBtn = New-Object System.Windows.Forms.Button
$deployBtn.Text = 'Deploy'
$deployBtn.Width = 140
$deployBtn.Height = 44
$deployBtn.Font = New-Object System.Drawing.Font('Segoe UI',11,[System.Drawing.FontStyle]::Bold)
$deployBtn.BackColor = $accent
$deployBtn.ForeColor = [System.Drawing.Color]::White
$deployBtn.Anchor = [System.Windows.Forms.AnchorStyles]::Right
$deployBtn.Left = $buttons.ClientSize.Width - $deployBtn.Width - 12
$deployBtn.Top = [int](($buttons.ClientSize.Height - $deployBtn.Height)/2)
$buttons.Controls.Add($deployBtn)

# reposition deploy button on resize
$buttons.Add_Resize({ try { $deployBtn.Left = $buttons.ClientSize.Width - $deployBtn.Width - 12; $deployBtn.Top = [int](($buttons.ClientSize.Height - $deployBtn.Height)/2) } catch {} })

# UI helpers
function Append-UiLog { param($m) $ts=(Get-Date).ToString('yyyy-MM-dd HH:mm:ss'); $entry="[$ts] $m`r`n"; if ($logBox.InvokeRequired) { $logBox.Invoke([Action]{ $logBox.AppendText($entry) }) } else { $logBox.AppendText($entry) } }
function Update-Status { param($c,$s,$v) try { $val1.Text = $c; $val2.Text = $s; $val3.Text = $v } catch {} }

# Populate services when component changed
$componentBox.Add_SelectedIndexChanged({
    $serviceBox.Items.Clear()
    $path = if ($componentBox.SelectedItem -eq 'style') { $LocalStylePath } else { $LocalAppStyle }
    if (Test-Path $path) {
        Get-ChildItem -Path $path -Directory -ErrorAction SilentlyContinue | ForEach-Object { $serviceBox.Items.Add($_.Name) | Out-Null }
    }
    if ($serviceBox.Items.Count -gt 0) { $serviceBox.SelectedIndex = 0 }
})
$componentBox.SelectedIndex = 0

# Update status card when selection changes
$serviceBox.Add_SelectedIndexChanged({ Update-Status $componentBox.SelectedItem $serviceBox.SelectedItem $versionBox.Text })
$componentBox.Add_SelectedIndexChanged({ Update-Status $componentBox.SelectedItem $serviceBox.SelectedItem $versionBox.Text })
$versionBox.Add_Leave({ Update-Status $componentBox.SelectedItem $serviceBox.SelectedItem $versionBox.Text })

# Buttons actions (preserve deploy logic)
$openBtn.Add_Click({
    $folder = Join-Path (Join-Path $TargetTempDir 'logs') (Get-Date -Format 'yyyy-MM-dd')
    Ensure-Path $folder
    Start-Process explorer.exe $folder
})

$deployBtn.Add_Click({
    try {
        $component = $componentBox.SelectedItem
        $artifact  = $serviceBox.SelectedItem
        $version   = $versionBox.Text.Trim()
        if ($version -eq $versionHint) { $version = '' }
        if (-not ($component -and $artifact -and $version)) {
            Show-Dialog 'Please fill all fields.' 'Validation Error' [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Warning
            return
        }
        $targetDir = $TargetTempDir; $logDir = Join-Path $targetDir 'logs'; $dateFolder = Join-Path $logDir (Get-Date -Format 'yyyy-MM-dd')
        Ensure-Path $targetDir; Ensure-Path $logDir; Ensure-Path $dateFolder
        $logFile = Join-Path $dateFolder ($artifact + '-' + $version + '.log')

        Append-UiLog ('Starting deployment: ' + $component + '/' + $artifact + '/' + $version)
        Update-Status $component $artifact $version

        $isSnapshot = $version -like '*SNAPSHOT*'
        if ($isSnapshot) { $url = $BaseSnapshotUrl + '/' + $artifact + '/' + $version + '/' + $artifact + '-' + $version + '.jar' }
        else { $url = $BaseReleaseUrl + '/' + $artifact + '/' + $version + '/' + $artifact + '-' + $version + '.jar' }

        Append-UiLog ('Constructed URL: ' + $url)
        $progressBar.Value = 10; $percentLabel.Text = '10%'

        $artifactPath = Join-Path $targetDir ($artifact + '-' + $version + '.jar')
        try {
            Invoke-WebRequest -Uri $url -OutFile $artifactPath -UseBasicParsing -ErrorAction Stop
            Append-UiLog ('Downloaded artifact to ' + $artifactPath)
            $progressBar.Value = 50; $percentLabel.Text = '50%'
        } catch {
            Append-UiLog ('Download failed: ' + $_.Exception.Message)
            Add-Content -Path $logFile -Value ('[' + (Get-Date) + '] Download failed: ' + $_.Exception.Message)
            Show-Dialog ('Download failed: ' + $_.Exception.Message) 'Error' [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
            return
        }

        $deployPath = if ($component -eq 'style') { Join-Path $LocalStylePath $artifact } else { Join-Path $LocalAppStyle $artifact }
        Append-UiLog ('Deploy folder: ' + $deployPath)

        if (-not (Test-Path $deployPath)) {
            Append-UiLog ('Deployment folder not found: ' + $deployPath)
            Add-Content -Path $logFile -Value ('[' + (Get-Date) + '] Deployment folder not found: ' + $deployPath)
            Show-Dialog ('Deployment folder not found: ' + $deployPath) 'Error' [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
            return
        }

        $existingJar = Join-Path $deployPath ($artifact + '.jar')
        if (Test-Path $existingJar) { Remove-Item $existingJar -Force; Append-UiLog ('Removed existing jar: ' + $existingJar) }
        else { Append-UiLog 'No existing jar to remove.' }

        Copy-Item -Path $artifactPath -Destination $existingJar -Force
        Append-UiLog ('Copied new artifact to ' + $existingJar)
        $progressBar.Value = 100; $percentLabel.Text = '100%'

        Add-Content -Path $logFile -Value ('[' + (Get-Date) + '] Deployment completed successfully.')
        Append-UiLog 'Deployment completed successfully.'
        Update-Status $component $artifact $version
        Show-Dialog 'Deployment completed successfully.' 'Success' [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Information

    } catch {
        Append-UiLog ('Unhandled error: ' + $_.Exception.Message)
        Show-Dialog ('Unhandled error: ' + $_.Exception.Message) 'Error' [System.Windows.Forms.MessageBoxButtons]::OK [System.Windows.Forms.MessageBoxIcon]::Error
    }
})

# Initialize status values
Update-Status $componentBox.SelectedItem $serviceBox.SelectedItem $versionBox.Text

# Show form
$form.Topmost = $true
[void]$form.ShowDialog()
